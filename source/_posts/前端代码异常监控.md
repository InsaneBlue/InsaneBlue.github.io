---
title: 前端代码异常监控
date: 2019-01-12 19:50:42
tags: [前端工程化, javascript]
categories: [前端工程化, javascript]
---

# 前端代码异常监控

## 前言

本文主要从如下几个方面来介绍：

1. 前端代码异常类型
2. 异常上报方式
3. 异常上报常见问题
4. 异常上报的解决方案
5. 未解决的问题

<!--more-->

## 前端代码异常类型

### js代码异常

对于 Javascript 而言，我们面对的仅仅只是异常，异常的出现不会直接导致 JS 引擎崩溃，最多只会使当前执行的任务终止。

1. 当前代码块将作为一个任务压入任务队列中，JS 线程会不断地从任务队列中提取任务执行。
2, 当任务执行过程中出现异常，且异常没有捕获处理，则会一直沿着调用栈一层层向外抛出，最终终止当前任务的执行。
3. JS 线程会继续从任务队列中提取下一个任务继续执行。

```
<script>
  error
  console.log('永远不会执行');
</script>
<script>
  console.log('我继续执行')
</script>
```

{% asset_img p1.png %}

+ try-catch 异常处理

  try-catch 在我们的代码中经常见到，通过给代码块进行 try-catch 进行包装后，当代码块发生出错时 catch 将能捕捉到错误的信息，页面也将可以继续执行。

  但是 try-catch 处理异常的能力有限，只能捕获捉到运行时非异步错误，对于语法错误和异步错误就显得无能为力，捕捉不到。

  ```javascript
  // 示例：运行时错误
  try {
    error    // 未定义变量 
  } catch(e) {
    console.log('我知道错误了');
    console.log(e);
  }
  ```

  然而对于语法错误和异步错误就捕捉不到了。

  ```javascript
  // 示例：语法错误
  try {
      function empty()   // <-  throw error 语法错误
  } catch(e){
      console.log('语法错误信息 ↙');
      console.log(e);
  }
  ```

  一般语法错误在编辑器就会体现出来，常表现的错误信息为： Uncaught SyntaxError: Invalid or unexpected token xxx 这样。但是这种错误会直接抛出异常，常使程序崩溃，一般在编码时候容易观察得到。

  ```javascript
  // 示例：异步错误
  try {
    setTimeout(() => {
      error        // 异步错误
    })
  } catch(e) {
    console.log('我感知不到错误');
    console.log(e);
  }
  ```
  除非你在 setTimeout 函数中再套上一层 try-catch，否则就无法感知到错误。

+ window.onerror事件

  ```javascript
  /**
  * @param {String}  msg    错误信息
  * @param {String}  url    出错文件
  * @param {Number}  row    行号
  * @param {Number}  col    列号
  * @param {Object}  error  错误详细信息
  */
  window.onerror = function (msg, url, row, col, error) {
      console.log('onerror 错误信息 ↙');
      console.log({
          msg,  url,  row, col, error
      })
  };

  test // <-  throw error
  ```
{% asset_img p2.png %}

  window.onerror 能捕捉到当前页面的语法错误、运行时报错和异步错误。
  在使用过程中的体会：onerror 主要用来捕获预料之外的错误，而 try-catch 则可以用在预知情况下监控特定错误，两种形式结合使用更加高效。

  需要注意的几点：
  1. window.onerror函数只有在返回 true 的时候，异常才不会向上抛出，控制台也不会显示错误，否则即使是知道异常的发生控制台还是会显示 Uncaught Error: xxxxx。
  2. onerror的事件注册，最好写在需要监控的JS脚本前面，这样才能保证错误发生时能够正确捕获到异常，如果错误发生之后再注册事件，异常是不会被onerror捕获到的。
  3. onerror无法捕获到网络异常的错误。

  这里可以使用window.addEventListener('error')来监听网络异常
  由于网络请求异常不会事件冒泡，因此必须在捕获阶段将其捕捉到才行，但是这种方式虽然可以捕捉到网络请求的异常，但是无法判断 HTTP 的状态是 404 还是其他比如 500 等等，所以还需要配合服务端日志才进行排查分析才可以。

  ```javascript
  window.addEventListener('error', (msg, url, row, col, error) => {
    console.log('我知道 404 错误了');
    console.log(
      msg, url, row, col, error
    );
    return true;
  }, true);
  // 404 not found
  <img src="./404.png" alt="">
  ```
  

## 异常上报方式
监控拿到报错信息之后，接下来就是异常信息进行上报，常用的发送形式主要有两种:

  1. 通过 Ajax 发送数据
  2. 动态创建 img 标签的形式

```javascript
// 动态创建 img 标签进行上报
function report(error) {
  var reportUrl = 'http://xxxx/report';
  new Image().src = reportUrl + 'error=' + error;
}
```

## 异常上报常见问题
  1. 压缩代码无法定位
  2. 
## 异常上报的解决方案
## 未解决的问题